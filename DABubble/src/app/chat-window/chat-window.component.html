<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="left">
      <h2>
        <ng-container *ngIf="activeUser; else channelHeader">
          {{ activeUser.name }}
        </ng-container>
        <ng-template #channelHeader>
          # {{ activeChannelName }}
        </ng-template>
      </h2>
    </div>
    <div class="right">
      <div class="avatars" (click)="toggleUserDropdown()">
        <img
          *ngFor="let user of currentChannelUsers.slice(0, 3)"
          [src]="user.avatar"
          [alt]="user.name"
        />
        <ng-container *ngIf="currentChannelUsers.length > 3">
          <div class="more-users">+{{ currentChannelUsers.length - 3 }}</div>
        </ng-container>
      </div>
      <span>{{ currentChannelUsers.length }}</span>
      <button class="add-user-btn" (click)="openAddUserDialog()">
        <mat-icon>person_add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Nutzerliste -->
  <div *ngIf="showFullUserList" class="user-dropdown" #userDropdownRef>
    <div *ngFor="let user of currentChannelUsers" class="user-option">
      <img [src]="user.avatar" />
      <span>{{ user.name }}</span>
    </div>
  </div>

  <!-- Nachrichtenbereich -->
  <div class="chat-messages">
    <div *ngIf="!groupedMessages.length" class="empty-state">
      <ng-container *ngIf="activeUser; else fallbackChannelInfo">
        <h3>{{ activeUser.name }}</h3>
        <p>
          Diese Unterhaltung findet nur zwischen
          <strong>{{ activeUser.name }}</strong> und dir statt.
        </p>
      </ng-container>
      <ng-template #fallbackChannelInfo>
        <h3># {{ activeChannelName }}</h3>
        <p>
          Du hast diesen Channel heute erstellt. Das ist der Anfang des Channels
          <strong># {{ activeChannelName }}</strong>.
        </p>
      </ng-template>
    </div>

    <ng-container *ngFor="let group of groupedMessages">
      <p class="date-label">{{ group.dateLabel }}</p>

      <div
        *ngFor="let message of group.messages"
        class="message-wrapper"
        [ngClass]="{ self: message.isSelf }"
        (mouseenter)="hoveredMessage = message"
        (mouseleave)="hoveredMessage = null"
      >
        <img class="avatar" [src]="message.avatar" [alt]="message.author" />
        <div class="message">
          <div class="message-toolbar" *ngIf="hoveredMessage === message">
            <span
              *ngFor="let emoji of emojis.slice(4, 7)"
              (click)="toggleReaction(message, emoji)"
            >
              {{ emoji }}
            </span>
            <button class="reply-icon" (click)="replyTo(message)">ðŸ’¬</button>
            <button
              *ngIf="message.isSelf && editingMessageId !== message.id"
              class="message-menu-button"
              (click)="startEditing(message)"
              matTooltip="Nachricht bearbeiten"
            >
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>

          <div class="meta">
            <span class="author">{{ message.author }}</span>
            <span class="time">
  {{ message.time }}
  <span *ngIf="message.edited" class="edited-flag">Â· bearbeitet</span>
</span>

          </div>

          <div class="content" *ngIf="editingMessageId !== message.id">
            {{ message.content }}
          </div>

          <div *ngIf="editingMessageId === message.id" class="edit-form">
            <input [(ngModel)]="editedMessageContent" />
            <button (click)="saveEdit(message)">Speichern</button>
            <button (click)="cancelEdit()">Abbrechen</button>
          </div>

<div class="reply-meta" *ngIf="message.replies?.length">
  <ng-container *ngIf="activeUser; else threadLink">
    <div class="dm-replies">
      <div
        *ngFor="let reply of message.replies"
        class="message-wrapper reply"
        [ngClass]="{ self: reply.isSelf }"
      >
        <img class="avatar" [src]="reply.avatar" [alt]="reply.author" />
        <div class="message">
          <div class="meta">
            <span class="author">{{ reply.author }}</span>
            <span class="time">{{ reply.time }}</span>
          </div>
          <div class="content">{{ reply.content }}</div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #threadLink>
    <a href="#" (click)="replyTo(message); $event.preventDefault()">
      {{ message.replies?.length }} Antworten
    </a>
    â€“ <span>Letzte Antwort {{ getLastReplyTime(message) }}</span>
  </ng-template>
</div>



          <div class="reactions" *ngIf="message.reactions?.length">
            <span
              *ngFor="let r of message.reactions"
              [matTooltip]="getUserNamesFromIds(r.users).join(', ')"
            >
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Eingabe -->
  <div class="chat-input">
    <input
      [(ngModel)]="newMessage"
      [placeholder]="activeUser ? 'Nachricht an ' + activeUser.name : 'Nachricht an #' + activeChannelName"
      (keydown.enter)="sendMessage()"
    />
    <button (click)="toggleEmojiPicker()">ðŸ˜Š</button>
    <button (click)="toggleUserList()">&#64;</button>
    <button class="send" (click)="sendMessage()">âž¤</button>

    <div class="emoji-picker" *ngIf="showEmojis">
      <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">
        {{ emoji }}
      </span>
    </div>

    <div class="mention-picker" *ngIf="showUsers">
      <div
        class="user-option"
        *ngFor="let user of currentChannelUsers"
        (click)="mentionUser(user)"
      >
        <img [src]="user.avatar" />
        <span>{{ user.name }}</span>
      </div>
    </div>
  </div>
</div>
