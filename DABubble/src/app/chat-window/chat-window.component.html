<div class="chat-container">
<div class="chat-header">
  <div class="left">
    <!-- Direktnachricht -->
    <ng-container *ngIf="activeUser; else channelHeader">
      <img
        class="large-avatar"
        [src]="activeUser.avatar"
        [alt]="getDisplayName(activeUser)"
        (click)="openUserProfileFromUser(activeUser)"
        style="cursor: pointer"
      />
      <div class="user-info">
        <h2 (click)="openUserProfileFromUser(activeUser)" style="cursor: pointer">
          {{ getDisplayName(activeUser) }}
        </h2>
      </div>
    </ng-container>

    <!-- Channelansicht -->
    <ng-template #channelHeader>
      <div class="channel-header">
        <h2>
          # {{ activeChannelName }}
          <button mat-icon-button (click)="openChannelInfo()" aria-label="Channel-Info anzeigen">
            <mat-icon>arrow_drop_down</mat-icon>
          </button>
        </h2>
      </div>
    </ng-template>
  </div>

  <!-- Rechtes Panel nur im Channel-Modus -->
  <div class="right" *ngIf="!activeUser">
    <div class="avatars" (click)="toggleUserDropdown()">
      <img
        *ngFor="let user of currentChannelUsers.slice(0, 3)"
        [src]="user.avatar"
        [alt]="getDisplayName(user)"
      />
      <ng-container *ngIf="currentChannelUsers.length > 3">
        <div class="more-users">+{{ currentChannelUsers.length - 3 }}</div>
      </ng-container>
    </div>
    <span>{{ currentChannelUsers.length }}</span>
    <button class="add-user-btn" (click)="openAddUserDialog()">
      <mat-icon>person_add</mat-icon>
    </button>
  </div>
</div>


  <!-- Nutzerliste -->
  <div *ngIf="showFullUserList" class="user-dropdown" #userDropdownRef>
    <div *ngFor="let user of currentChannelUsers" class="user-option">
      <img [src]="user.avatar" />
      <span>{{ getDisplayName(user) }}</span>
    </div>
  </div>

  <!-- Nachrichtenbereich -->
  <div class="chat-messages">
    <div *ngIf="!groupedMessages.length" class="empty-state">
      <ng-container *ngIf="isSelfChat; else normalDmOrChannel">
        <div class="self-chat-info">
          <img
            class="large-avatar"
            [src]="currentUser.avatar"
            [alt]="getDisplayName(currentUser)"
            (click)="openUserProfileFromUser(currentUser)"
            style="cursor: pointer"
          />
          <div class="info-text">
            <h2 (click)="openUserProfileFromUser(currentUser)" style="cursor: pointer">
              {{ getDisplayName(currentUser) }}
            </h2>
            <p>
              <strong>Dieser Raum ist nur fÃ¼r dich da.</strong> Mache dir Notizen, liste deine
              To-dos auf oder bewahre Links und Dateien griffbereit auf. Du kannst hier auch gerne
              Dinge mit dir selbst besprechen.
            </p>
          </div>
        </div>
      </ng-container>

      <ng-template #normalDmOrChannel>
        <ng-container *ngIf="activeUser; else fallbackChannelInfo">
          <div class="self-chat-info">
            <img
              class="large-avatar"
              [src]="activeUser.avatar"
              [alt]="getDisplayName(activeUser)"
              (click)="openUserProfileFromUser(activeUser)"
            />
            <div class="info-text">
              <h2>{{ getDisplayName(activeUser) }}</h2>
              <p>
                Diese Unterhaltung findet nur zwischen
                <strong>{{ getDisplayName(activeUser) }}</strong> und dir statt.
              </p>
            </div>
          </div>
        </ng-container>

<ng-template #fallbackChannelInfo>
  <ng-container *ngIf="activeChannelName; else nothingLeft">
    <h3># {{ activeChannelName }}</h3>
    <p>
      Du hast diesen Channel heute erstellt. Das ist der Anfang des Channels
      <strong># {{ activeChannelName }}</strong>.
    </p>
  </ng-container>

  <ng-template #nothingLeft>
    <div class="empty-state">
      <p><strong>Kein Channel ausgewÃ¤hlt.</strong></p>
      <p>WÃ¤hle einen Channel in der Sidebar oder erstelle einen neuen.</p>
    </div>
  </ng-template>
</ng-template>


      </ng-template>
    </div>

    <ng-container *ngFor="let group of groupedMessages">
      <p class="date-label">{{ group.dateLabel }}</p>

      <div
        *ngFor="let message of group.messages"
        class="message-wrapper"
        [ngClass]="{ self: message.isSelf }"
        (mouseenter)="hoveredMessage = message"
        (mouseleave)="hoveredMessage = null"
      >
        <img
          class="avatar"
          [src]="message.avatar"
          [alt]="getDisplayNameFromString(message.userId, message.author)"
          (click)="openUserProfile(message)"
        />
<div class="message">
  <!-- Emoji-Popover: MUSS vor der Toolbar stehen -->
  <div
    class="emoji-picker popover"
    *ngIf="emojiPopoverMessage === message"
    (click)="$event.stopPropagation()"
  >
    <span *ngFor="let emoji of emojis" (click)="addReaction(message, emoji)">
      {{ emoji }}
    </span>
  </div>

  <!-- TOOLBAR -->
  <div class="message-toolbar" *ngIf="hoveredMessage === message">
    <span *ngFor="let emoji of emojis.slice(4, 7)" (click)="toggleReaction(message, emoji)">
      {{ emoji }}
    </span>
    <span class="emoji-plus" (click)="toggleEmojiPopover(message)">âž•</span>
    <span class="reply-icon" (click)="replyTo(message)">ðŸ’¬</span>



    <button
      *ngIf="message.isSelf && editingMessageId !== message.id"
      class="message-menu-button"
      (click)="startEditing(message)"
      matTooltip="Nachricht bearbeiten"
    >
      <mat-icon>more_vert</mat-icon>
  </button>
</div>


          <div class="meta">
            <span class="author" (click)="openUserProfile(message)">
              {{ getDisplayNameFromString(message.userId, message.author) }}
            </span>
            <span class="time">
              {{ message.time }}
              <span *ngIf="message.edited" class="edited-flag">Â· bearbeitet</span>
            </span>
          </div>

          <div class="content" *ngIf="editingMessageId !== message.id">
            {{ message.content }}
          </div>

          <div *ngIf="editingMessageId === message.id" class="edit-form">
            <input [(ngModel)]="editedMessageContent" />
            <button (click)="saveEdit(message)">Speichern</button>
            <button (click)="cancelEdit()">Abbrechen</button>
          </div>

          <!-- REPLIES -->
          <div class="reply-meta" *ngIf="message.replies?.length">
            <ng-container *ngIf="activeUser; else channelReplyLink">
              <div class="dm-replies">
                <div
                  *ngFor="let reply of message.replies"
                  class="message-wrapper reply"
                  [ngClass]="{ self: reply.isSelf }"
                >
                  <img
                    class="avatar"
                    [src]="reply.avatar"
                    [alt]="getDisplayNameFromString(reply.userId, reply.author)"
                    (click)="openUserProfile(reply)"
                    style="cursor: pointer"
                  />

                  <div class="message">
                    <div class="meta">
                      <span class="author" (click)="openUserProfile(reply)">
                        {{ getDisplayNameFromString(reply.userId, reply.author) }}
                      </span>
                      <span class="time">{{ reply.time }}</span>
                    </div>
                    <div class="content">{{ reply.content }}</div>
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #channelReplyLink>
              <a href="#" (click)="replyTo(message); $event.preventDefault()">
                {{ message.replies?.length }} Antworten
              </a>
              <span>â€“ Letzte Antwort {{ getLastReplyTime(message) }}</span>
            </ng-template>
          </div>

          <div class="reactions" *ngIf="message.reactions?.length">
            <span
              *ngFor="let r of message.reactions"
              [matTooltip]="getUserNamesFromIds(r.users).join(', ')"
            >
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Eingabe -->
<div class="chat-input">
<!-- wichtig fÃ¼r AutovervollstÃ¤ndigung -->
<input
  [(ngModel)]="newMessage"
  [placeholder]="activeUser ? 'Nachricht an ' + getDisplayName(activeUser) : 'Nachricht an #' + activeChannelName"
  (keydown.enter)="sendMessage()"
  (input)="onMessageInput()" />

  <button (click)="toggleEmojiPicker()">ðŸ˜Š</button>
  <button *ngIf="!activeUser" (click)="toggleUserList()">&#64;</button>
  <button class="send" (click)="sendMessage()">âž¤</button>

  <!-- Emoji-Picker -->
  <div class="emoji-picker" *ngIf="showEmojis">
    <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">
      {{ emoji }}
    </span>
  </div>

<div class="mention-picker" *ngIf="showUsers" #mentionPickerRef>
  <div
    class="user-option"
    *ngFor="let user of filteredUsers"
    (click)="mentionUser(user)"
  >
    <img [src]="user.avatar" />
    <span>{{ getDisplayName(user) }}</span>
  </div>

  <div
    class="channel-option"
    *ngFor="let channel of filteredChannels"
    (click)="mentionChannel(channel)"
  >
    #{{ channel }}
  </div>
</div>

</div>

</div>
