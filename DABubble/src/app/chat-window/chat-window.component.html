<div class="chat-container">
  <div class="chat-header">
    <div class="left">
      <!-- Direktnachricht -->
      <ng-container *ngIf="activeUser; else channelHeader">
        <img
          class="large-avatar"
          [src]="activeUser.avatar"
          [alt]="getDisplayName(activeUser)"
          (click)="openUserProfileFromUser(activeUser)"
          style="cursor: pointer"
          matTooltip="Profil anzeigen"
        />
        <div class="user-info">
          <h2 (click)="openUserProfileFromUser(activeUser)" style="cursor: pointer" matTooltip="Profil anzeigen">
            {{ getDisplayName(activeUser) }}
          </h2>
        </div>
      </ng-container>

      <!-- Channelansicht -->
      <ng-template #channelHeader>
        <div class="channel-header">
          <h2>
            # {{ activeChannelName }}
            <button mat-icon-button (click)="openChannelInfo()" aria-label="Channel-Info anzeigen" matTooltip="Channel-Info anzeigen">
              <mat-icon>arrow_drop_down</mat-icon>
            </button>
          </h2>
        </div>
      </ng-template>
    </div>

    <!-- Rechtes Panel nur im Channel-Modus -->
    <div class="right" *ngIf="!activeUser">
      <div class="avatars" (click)="toggleUserDropdown()" matTooltip="Channel-Mitglieder anzeigen">
        <img
          *ngFor="let user of currentChannelUsers.slice(0, 3)"
          [src]="user.avatar"
          [alt]="getDisplayName(user)"
        />
        <ng-container *ngIf="currentChannelUsers.length > 3">
          <div class="more-users">+{{ currentChannelUsers.length - 3 }}</div>
        </ng-container>
      </div>
      <span>{{ currentChannelUsers.length }}</span>
      <button class="add-user-btn" (click)="openAddUserDialog()" matTooltip="Nutzer zum Channel einladen">
        <mat-icon>person_add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Nutzerliste -->
  <div *ngIf="showFullUserList" class="user-dropdown" #userDropdownRef>
    <div *ngFor="let user of currentChannelUsers" class="user-option">
      <img [src]="user.avatar" />
      <span>{{ getDisplayName(user) }}</span>
    </div>
  </div>

  <!-- Nachrichtenbereich -->
  <div class="chat-messages">
    <div *ngIf="!groupedMessages.length" class="empty-state">
      <ng-container *ngIf="isSelfChat; else normalDmOrChannel">
        <div class="self-chat-info">
          <img
            class="large-avatar"
            [src]="currentUser.avatar"
            [alt]="getDisplayName(currentUser)"
            (click)="openUserProfileFromUser(currentUser)"
            style="cursor: pointer"
            matTooltip="Profil anzeigen"
          />
          <div class="info-text">
            <h2 (click)="openUserProfileFromUser(currentUser)" style="cursor: pointer" matTooltip="Profil anzeigen">
              {{ getDisplayName(currentUser) }}
            </h2>
            <p>
              <strong>Dieser Raum ist nur fÃ¼r dich da.</strong> Mache dir Notizen, liste deine
              To-dos auf oder bewahre Links und Dateien griffbereit auf.
            </p>
          </div>
        </div>
      </ng-container>

      <ng-template #normalDmOrChannel>
        <ng-container *ngIf="activeUser; else fallbackChannelInfo">
          <div class="self-chat-info">
            <img
              class="large-avatar"
              [src]="activeUser.avatar"
              [alt]="getDisplayName(activeUser)"
              (click)="openUserProfileFromUser(activeUser)"
              matTooltip="Profil anzeigen"
            />
            <div class="info-text">
              <h2>{{ getDisplayName(activeUser) }}</h2>
              <p>Diese Unterhaltung findet nur zwischen <strong>{{ getDisplayName(activeUser) }}</strong> und dir statt.</p>
            </div>
          </div>
        </ng-container>

        <ng-template #fallbackChannelInfo>
          <ng-container *ngIf="activeChannelName; else nothingLeft">
            <h3># {{ activeChannelName }}</h3>
            <p>Du hast diesen Channel heute erstellt. Das ist der Anfang des Channels <strong># {{ activeChannelName }}</strong>.</p>
          </ng-container>

          <ng-template #nothingLeft>
            <div class="empty-state">
              <p><strong>Kein Channel ausgewÃ¤hlt.</strong></p>
              <p>WÃ¤hle einen Channel in der Sidebar oder erstelle einen neuen.</p>
            </div>
          </ng-template>
        </ng-template>
      </ng-template>
    </div>

    <ng-container *ngFor="let group of groupedMessages">
      <p class="date-label">{{ group.dateLabel }}</p>

      <div
        *ngFor="let message of group.messages"
        class="message-wrapper"
        [ngClass]="{ self: message.isSelf }"
        (mouseenter)="hoveredMessage = message"
        (mouseleave)="hoveredMessage = null"
      >
        <img
          class="avatar"
          [src]="getAvatarFromId(message.userId)"

          [alt]="getDisplayNameFromString(message.userId, message.author)"
          (click)="openUserProfile(message)"
          matTooltip="Profil anzeigen"
        />

        <div class="message">
          <div class="emoji-picker popover" *ngIf="emojiPopoverMessage === message" (click)="$event.stopPropagation()">
            <span *ngFor="let emoji of emojis" (click)="addReaction(message, emoji)">{{ emoji }}</span>
          </div>

          <div class="message-toolbar" *ngIf="hoveredMessage === message">
            <span *ngFor="let emoji of emojis.slice(4, 7)" (click)="toggleReaction(message, emoji)">{{ emoji }}</span>
            <span class="emoji-plus" (click)="toggleEmojiPopover(message)" matTooltip="Emoji hinzufÃ¼gen">âž•</span>
            <span class="reply-icon" (click)="replyTo(message)" matTooltip="Antworten">ðŸ’¬</span>
            <button *ngIf="message.isSelf && editingMessageId !== message.id"
              class="message-menu-button"
              (click)="startEditing(message)"
              matTooltip="Nachricht bearbeiten">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>

          <div class="meta">
            <span class="author" (click)="openUserProfile(message)">{{ getDisplayNameFromString(message.userId, message.author) }}</span>
            <span class="time">{{ message.time }}<span *ngIf="message.edited" class="edited-flag">Â· bearbeitet</span></span>
          </div>

<div class="bubble" *ngIf="editingMessageId !== message.id">
  {{ message.content }}
  <img *ngIf="message.url?.toLowerCase().endsWith('.png') || message.url?.toLowerCase().endsWith('.jpg') || message.url?.toLowerCase().endsWith('.jpeg')"
    [src]="message.url" alt="Bildanhang" style="max-width: 200px; border-radius: 8px; margin-top: 8px;" />
  <a *ngIf="message.url && !(message.url.toLowerCase().endsWith('.png') || message.url.toLowerCase().endsWith('.jpg') || message.url.toLowerCase().endsWith('.jpeg'))"
    [href]="message.url" target="_blank" style="display: block; margin-top: 8px; color: #5a65ea;">Datei Ã¶ffnen</a>
</div>


          <div *ngIf="editingMessageId === message.id" class="edit-form">
            <input [(ngModel)]="editedMessageContent" />
            <button (click)="saveEdit(message)" matTooltip="Speichern">Speichern</button>
            <button (click)="cancelEdit()" matTooltip="Abbrechen">Abbrechen</button>
          </div>

          <div class="reply-meta" *ngIf="message.replies?.length">
            <ng-container *ngIf="activeUser; else channelReplyLink">
              <div class="dm-replies">
                <div *ngFor="let reply of message.replies" class="message-wrapper reply" [ngClass]="{ self: reply.isSelf }">
                  <img class="avatar" [src]="getAvatarFromId(reply.userId)"
 [alt]="getDisplayNameFromString(reply.userId, reply.author)"
                    (click)="openUserProfile(reply)" style="cursor: pointer" matTooltip="Profil anzeigen" />
                  <div class="message">
                    <div class="meta">
                      <span class="author" (click)="openUserProfile(reply)">{{ getDisplayNameFromString(reply.userId, reply.author) }}</span>
                      <span class="time">{{ reply.time }}</span>
                    </div>
                    <div class="content">{{ reply.content }}</div>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #channelReplyLink>
              <a href="#" (click)="replyTo(message); $event.preventDefault()">
                {{ message.replies?.length }} Antworten
              </a>
              <span>â€“ Letzte Antwort {{ getLastReplyTime(message) }}</span>
            </ng-template>
          </div>

          <div class="reactions" *ngIf="message.reactions?.length">
            <span *ngFor="let r of message.reactions" [matTooltip]="getUserNamesFromIds(r.users).join(', ')">
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Eingabe -->
<div class="chat-input">
  <div class="input-box">
    <input
      [(ngModel)]="newMessage"
      [placeholder]="activeUser ? 'Nachricht an ' + getDisplayName(activeUser) : 'Nachricht an #' + activeChannelName"
      (keyup.enter)="sendMessage()"
      (input)="onMessageInput()"
    />

    <div class="input-footer">
      <div class="left-icons">
        <button type="button" (click)="toggleEmojiPicker()" matTooltip="Emoji-Picker Ã¶ffnen">ðŸ˜Š</button>
        <button *ngIf="!activeUser" type="button" (click)="toggleUserList()" matTooltip="Nutzer erwÃ¤hnen">&#64;</button>
        <button type="button" (click)="fileInput.click()" matTooltip="Datei anhÃ¤ngen">
          <mat-icon>attach_file</mat-icon>
        </button>
        <input #fileInput type="file" hidden (change)="onFileSelected($event)" />
      </div>

      <div class="right-icons">
        <button type="button" class="send" (click)="sendMessage()" matTooltip="Nachricht senden">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Emoji & Mention Picker -->
  <div class="emoji-picker" *ngIf="showEmojis" (click)="$event.stopPropagation()">
    <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)" matTooltip="Emoji einfÃ¼gen">{{ emoji }}</span>
  </div>

  <div class="mention-picker" *ngIf="showUsers" #mentionMenuRef>
    <div
      class="user-option"
      *ngFor="let user of filteredUsers"
      (click)="mentionUser(user)"
      matTooltip="@{{ user.name }} einfÃ¼gen"
    >
      <img [src]="user.avatar" />
      <span>{{ user.name }}</span>
    </div>
  </div>
</div>


</div>
