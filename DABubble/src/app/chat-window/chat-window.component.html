<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="left">
      <h2># {{ activeChannelName }}</h2>
    </div>
    <div class="right">
      <div class="avatars" (click)="toggleUserDropdown()">
        <img *ngFor="let user of currentChannelUsers.slice(0, 3)" [src]="user.avatar" [alt]="user.name" />
        <ng-container *ngIf="currentChannelUsers.length > 3">
          <div class="more-users">+{{ currentChannelUsers.length - 3 }}</div>
        </ng-container>
      </div>
      <span>{{ currentChannelUsers.length }}</span>
      <button class="add-user-btn" (click)="openAddUserDialog()">
        <mat-icon>person_add</mat-icon>
      </button>
    </div>
  </div>

  <!-- Nutzerliste -->
  <div *ngIf="showFullUserList" class="user-dropdown" #userDropdownRef>
    <div *ngFor="let user of currentChannelUsers" class="user-option">
      <img [src]="user.avatar" />
      <span>{{ user.name }}</span>
    </div>
  </div>

  <!-- Nachrichtenbereich -->
  <div class="chat-messages">
    <div *ngIf="!groupedMessages.length" class="empty-state">
      <h3># {{ activeChannelName }}</h3>
      <p>
        Du hast diesen Channel heute erstellt. Das ist der Anfang des Channels
        <strong># {{ activeChannelName }}</strong>.
      </p>
    </div>

    <ng-container *ngFor="let group of groupedMessages">
      <p class="date-label">{{ group.dateLabel }}</p>
      <div *ngFor="let message of group.messages"
           class="message-wrapper"
           [ngClass]="{ 'self': message.isSelf }"
           (mouseenter)="hoveredMessage = message"
           (mouseleave)="hoveredMessage = null">
        <img class="avatar" [src]="message.avatar" [alt]="message.author" />
        <div class="message">
          <div class="meta">
            <span class="author">{{ message.author }}</span>
            <span class="time">{{ message.time }}</span>
          </div>
          <div class="content">{{ message.content }}</div>
          <div class="reply-meta" *ngIf="message.replies?.length">
            <a href="#" (click)="replyTo(message)">
              {{ message.replies?.length || 0 }} Antworten
            </a>
            â€“
            <span>Letzte Antwort {{ getLastReplyTime(message) }}</span>
          </div>
          <div class="reactions" *ngIf="message.reactions?.length">
            <span *ngFor="let r of message.reactions"
                  [matTooltip]="getUserNamesFromIds(r.users).join(', ')">
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
          <div class="reaction-toolbar" *ngIf="hoveredMessage === message">
            <span *ngFor="let emoji of emojis.slice(4, 7)" (click)="toggleReaction(message, emoji)">
              {{ emoji }}
            </span>
            <span class="reply-icon" (click)="replyTo(message)">ðŸ’¬</span>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Eingabe -->
  <div class="chat-input">
    <input [(ngModel)]="newMessage"
           [placeholder]="'Nachricht an #' + activeChannelName"
           (keydown.enter)="sendMessage()" />
    <button (click)="toggleEmojiPicker()">ðŸ˜Š</button>
    <button (click)="toggleUserList()">&#64;</button>
    <button class="send" (click)="sendMessage()">âž¤</button>

    <div class="emoji-picker" *ngIf="showEmojis">
      <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)">{{ emoji }}</span>
    </div>

    <div class="mention-picker" *ngIf="showUsers">
      <div class="user-option" *ngFor="let user of currentChannelUsers" (click)="mentionUser(user)">
        <img [src]="user.avatar" />
        <span>{{ user.name }}</span>
      </div>
    </div>
  </div>
</div>
