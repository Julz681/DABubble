<div class="thread-container">
  <!-- Header -->
  <div class="thread-header">
    <div class="title">
      <strong>Thread</strong>
      <span class="channel"># {{ rootMessage?.userId ? 'Entwicklerteam' : '' }}</span>
    </div>
    <button mat-icon-button (click)="closeThreadPanel()" matTooltip="Thread schlieÃŸen">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Body -->
  <div class="thread-body" *ngIf="rootMessage">
    <!-- Root Message -->
    <div
      class="message"
      [ngClass]="{ own: rootMessage.userId === currentUserId }"
      (mouseenter)="hoveredMessageId = rootMessage.id"
      (mouseleave)="hoveredMessageId = null"
    >
      <!-- Popover -->
      <div
        class="emoji-picker popover"
        *ngIf="emojiPopoverMessage?.id === rootMessage.id"
        (click)="$event.stopPropagation()"
      >
        <span *ngFor="let emoji of emojis" (click)="addReaction(rootMessage, emoji)" matTooltip="Reaktion hinzufÃ¼gen">
          {{ emoji }}
        </span>
      </div>

      <!-- Toolbar -->
      <div class="reaction-toolbar" *ngIf="hoveredMessageId === rootMessage.id">
        <span *ngFor="let emoji of emojis.slice(4, 7)" (click)="toggleReaction(rootMessage, emoji)" matTooltip="Reaktion wÃ¤hlen">
          {{ emoji }}
        </span>
        <span class="emoji-plus" (click)="toggleEmojiPopover(rootMessage)" matTooltip="Weitere Emojis">âž•</span>
        <span class="reply-icon" (click)="replyTo(getUserNameFromId(rootMessage.userId))" matTooltip="Antworten">ðŸ’¬</span>
        <button
          *ngIf="rootMessage.userId === currentUserId && editingMessageId !== rootMessage.id"
          class="message-menu-button"
          (click)="startEditing(rootMessage)"
          matTooltip="Nachricht bearbeiten"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>

      <div class="message-content">
        <img [src]="rootMessage.avatar" class="avatar" (click)="openUserProfile(rootMessage)" matTooltip="Profil Ã¶ffnen" />
        <div class="bubble">
          <div class="author-time">
            <span class="author" (click)="openUserProfile(rootMessage)" matTooltip="Profil anzeigen">
              {{ getUserNameFromId(rootMessage.userId) }}
            </span>
            <span class="time">
              <span *ngIf="rootMessage.edited" class="edited-flag">bearbeitet</span>
            </span>
          </div>

          <div *ngIf="editingMessageId === rootMessage.id; else rootText" class="edit-form">
            <input [(ngModel)]="editedMessageContent" />
            <button (click)="saveEdit(rootMessage)" matTooltip="Speichern">Speichern</button>
            <button (click)="cancelEdit()" matTooltip="Abbrechen">Abbrechen</button>
          </div>
<ng-template #rootText>
  <!-- Datei-Vorschau -->
  <ng-container *ngIf="extractUrl(rootMessage.content); else normalRootText">
    <img
      *ngIf="isImageUrl(extractUrl(rootMessage.content))"
      [src]="extractUrl(rootMessage.content)"
      style="max-width: 200px; margin-top: 8px"
    />
    <a
      *ngIf="!isImageUrl(extractUrl(rootMessage.content))"
      [href]="extractUrl(rootMessage.content)"
      target="_blank"
    >Datei Ã¶ffnen</a>
  </ng-container>

  <ng-template #normalRootText>
    <div class="text">{{ rootMessage.content }}</div>
  </ng-template>
</ng-template>

          <div class="reactions" *ngIf="rootMessage.reactions?.length">
            <span *ngFor="let r of rootMessage.reactions" [matTooltip]="getUserNamesFromIds(r.users).join(', ')">
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Replies Info -->
    <div class="reply-info" *ngIf="replies.length > 0">
      <a href="#" matTooltip="Thread anzeigen">{{ replies.length }} Antworten</a>
      <span>Letzte Antwort {{ getLastReplyTime() }}</span>
    </div>

    <!-- Replies -->
    <div
      *ngFor="let msg of replies"
      class="message"
      [ngClass]="{ own: msg.userId === currentUserId }"
      (mouseenter)="hoveredMessageId = msg.id"
      (mouseleave)="hoveredMessageId = null"
    >
      <!-- Popover -->
      <div
        class="emoji-picker popover"
        *ngIf="emojiPopoverMessage?.id === msg.id"
        (click)="$event.stopPropagation()"
      >
        <span *ngFor="let emoji of emojis" (click)="addReaction(msg, emoji)" matTooltip="Reaktion hinzufÃ¼gen">
          {{ emoji }}
        </span>
      </div>

      <!-- Toolbar -->
      <div class="reaction-toolbar" *ngIf="hoveredMessageId === msg.id">
        <span *ngFor="let emoji of emojis.slice(4, 7)" (click)="toggleReaction(msg, emoji)" matTooltip="Reaktion wÃ¤hlen">
          {{ emoji }}
        </span>
        <span class="emoji-plus" (click)="toggleEmojiPopover(msg)" matTooltip="Weitere Emojis">âž•</span>
        <span class="reply-icon" (click)="replyTo(getUserNameFromId(msg.userId))" matTooltip="Antworten">ðŸ’¬</span>
        <button
          *ngIf="msg.userId === currentUserId && editingMessageId !== msg.id"
          class="message-menu-button"
          (click)="startEditing(msg)"
          matTooltip="Nachricht bearbeiten"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>

      <div class="message-content">
        <img [src]="msg.avatar" class="avatar" (click)="openUserProfile(msg)" matTooltip="Profil Ã¶ffnen" />
        <div class="bubble">
          <div class="author-time">
            <span class="author" (click)="openUserProfile(msg)" matTooltip="Profil anzeigen">
              {{ getUserNameFromId(msg.userId) }}
            </span>
            <span class="time">{{ msg.time }}</span>
          </div>

          <div *ngIf="editingMessageId === msg.id; else msgText" class="edit-form">
            <input [(ngModel)]="editedMessageContent" />
            <button (click)="saveEdit(msg)" matTooltip="Speichern">Speichern</button>
            <button (click)="cancelEdit()" matTooltip="Abbrechen">Abbrechen</button>
          </div>
<ng-template #msgText>
  <ng-container *ngIf="isMarkdownLink(msg.content); else normalText">
    <div class="text">
      <span>{{ extractFileName(msg.content) }}</span><br />
      <a
        [href]="extractUrl(msg.content)"
        target="_blank"
        rel="noopener noreferrer"
        style="font-size: 0.85rem; color: #5c6bc0"
        matTooltip="Datei Ã¶ffnen"
      >
        Datei Ã¶ffnen
      </a>
    </div>
  </ng-container>

  <ng-template #normalText>
    <div class="text">{{ msg.content }}</div>
  </ng-template>
</ng-template>

          <div class="reactions" *ngIf="msg.reactions?.length">
            <span *ngFor="let r of msg.reactions" [matTooltip]="getUserNamesFromIds(r.users).join(', ')">
              {{ r.emoji }} {{ r.count }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
<div class="thread-input">
  <div class="input-box">
    <input
      #messageInput
      [(ngModel)]="newMessage"
      placeholder="Antwortenâ€¦"
      (keyup.enter)="sendMessage()"
      (input)="onMessageInput()"
    />

<div class="input-footer">
  <div class="left-icons">
    <button type="button" (click)="toggleEmojiPicker()" matTooltip="Emoji-Picker Ã¶ffnen">ðŸ˜Š</button>
    <button type="button" (click)="toggleUserList()" matTooltip="Nutzer erwÃ¤hnen">&#64;</button>
    <button type="button" (click)="fileInput.click()" matTooltip="Datei anhÃ¤ngen">
      <mat-icon>attach_file</mat-icon>
    </button>
    <input #fileInput type="file" hidden (change)="onFileSelected($event)" />
  </div>

  <div class="right-icons">
    <button type="button" class="send" (click)="sendMessage()" matTooltip="Nachricht senden">
      <mat-icon>send</mat-icon>
    </button>
  </div>
</div>

  </div>

  <!-- Emoji & Mention Picker bleiben gleich -->
  <div class="emoji-picker" *ngIf="showEmojis" (click)="$event.stopPropagation()">
    <span *ngFor="let emoji of emojis" (click)="addEmoji(emoji)" matTooltip="Emoji einfÃ¼gen">{{ emoji }}</span>
  </div>

  <div class="mention-picker" *ngIf="showUsers" #mentionMenuRef>
    <div
      class="user-option"
      *ngFor="let user of filteredUsers"
      (click)="mentionUser(user)"
      matTooltip="@{{ user.name }} einfÃ¼gen"
    >
      <img [src]="user.avatar" />
      <span>{{ user.name }}</span>
    </div>
  </div>
</div>

</div>